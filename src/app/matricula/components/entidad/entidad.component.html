<app-general-loading-spinner [visible]="loading || isSaving" [message]="spinnerMessage"></app-general-loading-spinner>

<!-- Vista de Solo Lectura -->
<div class="main-container" *ngIf="!isEditing && entidad && !loading">
  <div class="header">
    <h2>{{ entidad.nombreColegio }}</h2>
    <div class="logo-container">
      <img [src]="entidad.logoColegio" alt="Logo del Colegio">
    </div>
  </div>

  <div class="form-columns">
    <!-- Columna 1: Datos de contacto y documentos -->
    <div class="column">
      <div class="form-group">
        <label>RUC del Colegio</label>
        <div class="input-with-icon">
          <i class="fas fa-id-card input-icon"></i>
          <input type="text" [value]="entidad.rucColegio" disabled>
        </div>
      </div>
      <div class="form-group">
        <label>Razón Social</label>
        <div class="input-with-icon">
          <i class="fas fa-signature input-icon"></i>
          <input type="text" [value]="entidad.razonSocial" disabled>
        </div>
      </div>
      <div class="info-section">
        <h3><i class="fas fa-file-alt"></i> Documentos Requeridos</h3>
        <div class="info-group" *ngIf="entidad.documentos?.necesarios">
          <h4>Necesarios</h4>
          <ul class="info-list">
            <li><span>{{ entidad.documentos?.necesarios?.documento1 }}</span></li>
            <li><span>{{ entidad.documentos?.necesarios?.documento2 }}</span></li>
          </ul>
        </div>
        <div class="info-group" *ngIf="entidad.documentos?.adicionales">
          <h4>Adicionales</h4>
          <ul class="info-list">
            <li *ngIf="entidad.documentos?.adicionales?.intercambio">
              <h5>Intercambio</h5>
              <ul class="info-list">
                <li><span>{{ entidad.documentos?.adicionales?.intercambio?.documento1 }}</span></li>
                <li><span>{{ entidad.documentos?.adicionales?.intercambio?.documento2 }}</span></li>
              </ul>
            </li>
            <li *ngIf="entidad.documentos?.adicionales?.discapacidad">
              <h5>Discapacidad</h5>
              <ul class="info-list">
                <li><span>{{ entidad.documentos?.adicionales?.discapacidad?.documento1 }}</span></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Columna 2: Dirección, Teléfono, Correo y Niveles -->
    <div class="column">
      <div class="form-group">
        <label>Dirección</label>
        <div class="input-with-icon">
          <i class="fas fa-map-marker-alt input-icon"></i>
          <input type="text" [value]="entidad.direccionColegio" disabled>
        </div>
      </div>
      <div class="form-group">
        <label>Teléfono</label>
        <div class="input-with-icon">
          <i class="fas fa-phone input-icon"></i>
          <input type="tel" [value]="entidad.telefonoColegio" disabled>
        </div>
      </div>
      <div class="form-group">
        <label>Correo Electrónico</label>
        <div class="input-with-icon">
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" [value]="entidad.correoColegio" disabled>
        </div>
      </div>
      <div class="info-section">
        <h3><i class="fas fa-clipboard-list"></i> Datos Niveles</h3>
        <div class="grade-grid-wrapper">
          <ng-container *ngFor="let nivel of entidad.datosngs?.niveles; let nivelIndex = index">
            <h4 class="level-name"><b>{{ nivel.nombre }}</b></h4>
            <div class="grade-grid">
              <div class="grade-card" *ngFor="let grado of nivel.grados; let gradoIndex = index">
                <h5>Grado: {{ grado.nombre }}</h5>
                <div>Secciones:</div>
                <ul class="info-list">
                  <li *ngFor="let seccion of grado.secciones">
                    <span>{{ seccion.nombre }} ({{ seccion.vacantes }} vac.)</span>
                  </li>
                </ul>
                <button class="btn-edit-grade" (click)="openSectionsModal(nivelIndex, gradoIndex)">EDITAR</button>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
  <div class="button-container">
    <button type="button" class="btn btn-primary" (click)="iniciarEdicion()">EDITAR</button>
  </div>
</div>

<!-- Vista de Edición -->
<div class="main-container" *ngIf="isEditing && entidad && !loading">
  <form [formGroup]="entidadForm" (ngSubmit)="guardarCambios()" novalidate>
    <div class="header">
      <div class="form-group">
        <label for="nombreColegio">Nombre del Colegio</label>
        <input id="nombreColegio" type="text" formControlName="nombreColegio" class="form-control">
        <div *ngIf="entidadForm.get('nombreColegio')?.invalid && entidadForm.get('nombreColegio')?.touched" class="error-message">
          El nombre es requerido.
        </div>
      </div>
      <div class="logo-container">
        <img [src]="logoPreview" alt="Logo del Colegio">
        <div class="upload-overlay">
          <div class="upload-circle" (click)="triggerFileInput()">SELECCIONAR IMAGEN</div>
        </div>
        <input type="file" #logoInput hidden (change)="onLogoChange($event)" accept="image/*">
        <div *ngIf="entidadForm.get('logoColegio')?.invalid && entidadForm.get('logoColegio')?.touched" class="error-message">
          <span *ngIf="entidadForm.get('logoColegio')?.errors?.['required']">El logo es requerido.</span>
          <span *ngIf="entidadForm.get('logoColegio')?.errors?.['invalidUrl']">Formato de logo inválido.</span>
        </div>
      </div>
    </div>

    <div class="form-columns">
      <!-- Columna 1 -->
      <div class="column">
        <h4>Datos Generales</h4>
        <!-- RUC -->
        <div class="form-group">
          <label for="rucColegio">RUC</label>
          <input id="rucColegio" type="text" formControlName="rucColegio" class="form-control" maxlength="11">
          <div *ngIf="entidadForm.get('rucColegio')?.invalid && entidadForm.get('rucColegio')?.touched" class="error-message">
            <span *ngIf="entidadForm.get('rucColegio')?.errors?.['required']">RUC es requerido.</span>
            <span *ngIf="entidadForm.get('rucColegio')?.errors?.['pattern']">RUC debe tener 11 dígitos numéricos.</span>
          </div>
        </div>
        <!-- Razón Social -->
        <div class="form-group">
          <label for="razonSocial">Razón Social</label>
          <input id="razonSocial" type="text" formControlName="razonSocial" class="form-control">
          <div *ngIf="entidadForm.get('razonSocial')?.invalid && entidadForm.get('razonSocial')?.touched" class="error-message">
            La razón social es requerida.
          </div>
        </div>
      </div>
      <!-- Columna 2 -->
      <div class="column">
        <h4>Datos de Contacto</h4>
        <!-- Dirección -->
        <div class="form-group">
          <label for="direccionColegio">Dirección</label>
          <input id="direccionColegio" type="text" formControlName="direccionColegio" class="form-control">
          <div *ngIf="entidadForm.get('direccionColegio')?.invalid && entidadForm.get('direccionColegio')?.touched" class="error-message">
            La dirección es requerida.
          </div>
        </div>
        <!-- Teléfono -->
        <div class="form-group">
          <label for="telefonoColegio">Teléfono</label>
          <input id="telefonoColegio" type="tel" formControlName="telefonoColegio" class="form-control" maxlength="8">
          <div *ngIf="entidadForm.get('telefonoColegio')?.invalid && entidadForm.get('telefonoColegio')?.touched" class="error-message">
            <span *ngIf="entidadForm.get('telefonoColegio')?.errors?.['required']">El teléfono es requerido.</span>
            <span *ngIf="entidadForm.get('telefonoColegio')?.errors?.['pattern']">Debe tener 7 u 8 dígitos numéricos.</span>
          </div>
        </div>
        <!-- Correo -->
        <div class="form-group">
          <label for="correoColegio">Correo Electrónico</label>
          <input id="correoColegio" type="email" formControlName="correoColegio" class="form-control">
          <div *ngIf="entidadForm.get('correoColegio')?.invalid && entidadForm.get('correoColegio')?.touched" class="error-message">
            <span *ngIf="entidadForm.get('correoColegio')?.errors?.['required']">El correo es requerido.</span>
            <span *ngIf="entidadForm.get('correoColegio')?.errors?.['email']">Ingrese un correo válido.</span>
          </div>
        </div>
      </div>
    </div>

    <hr class="form-divider">

    <!-- Sección Documentos -->
    <div formGroupName="documentos">
      <h4>Documentos Requeridos</h4>
      <div class="form-columns">
        <div class="column" formGroupName="necesarios">
          <h5>Necesarios</h5>
          <div class="form-group">
            <label>Doc. Identidad Alumno</label>
            <input type="text" formControlName="documento1" class="form-control">
            <div *ngIf="entidadForm.get('documentos.necesarios.documento1')?.invalid && entidadForm.get('documentos.necesarios.documento1')?.touched" class="error-message">
              Este documento es requerido.
            </div>
          </div>
          <div class="form-group">
            <label>Doc. Identidad Apoderado</label>
            <input type="text" formControlName="documento2" class="form-control">
            <div *ngIf="entidadForm.get('documentos.necesarios.documento2')?.invalid && entidadForm.get('documentos.necesarios.documento2')?.touched" class="error-message">
              Este documento es requerido.
            </div>
          </div>
        </div>
        <div class="column" formGroupName="adicionales">
          <h5>Adicionales</h5>
          <div formGroupName="intercambio">
            <h6>Intercambio</h6>
            <div class="form-group">
              <label>Certificado Estudios</label>
              <input type="text" formControlName="documento1" class="form-control">
            </div>
            <div class="form-group">
              <label>Boleta de Notas</label>
              <input type="text" formControlName="documento2" class="form-control">
            </div>
          </div>
          <div formGroupName="discapacidad">
            <h6>Discapacidad</h6>
            <div class="form-group">
              <label>Certificado de Discapacidad</label>
              <input type="text" formControlName="documento1" class="form-control">
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="form-divider">

    <!-- Datos Niveles -->
    <div formGroupName="datosngs">
      <div class="info-section">
        <div class="dynamic-section-header">
          <h3><i class="fas fa-clipboard-list"></i> Datos Niveles</h3>
          <button type="button" (click)="addNivel()" class="btn-add-small">
            <i class="fas fa-plus"></i> Añadir Nivel
          </button>
        </div>
        <div *ngIf="niveles().invalid && niveles().touched" class="error-message">
          Debe haber al menos un nivel educativo.
        </div>
        <div class="grade-grid-wrapper" formArrayName="niveles">
          <ng-container *ngFor="let nivelCtrl of niveles().controls; let i=index" [formGroupName]="i">
            <div class="level-header">
              <h4 class="level-name">
                <b><input type="text" formControlName="nombre" class="level-input"></b>
              </h4>
              <button type="button" (click)="removeNivel(i)" class="btn-remove">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
            <div *ngIf="niveles().at(i).get('nombre')?.invalid && niveles().at(i).get('nombre')?.touched" class="error-message">
              El nombre del nivel es requerido.
            </div>
            <div class="dynamic-section-header-nested">
              <button type="button" (click)="addGrado(i)" class="btn-add-small">
                <i class="fas fa-plus"></i> Añadir Grado
              </button>
            </div>
            <div *ngIf="grados(i).invalid && grados(i).touched" class="error-message">
              Debe haber al menos un grado.
            </div>
            <div class="grade-grid" formArrayName="grados">
              <ng-container *ngFor="let gradoCtrl of grados(i).controls; let j=index" [formGroupName]="j">
                <div class="grade-card">
                  <div class="grade-header">
                    <h5>Grado: <input type="text" formControlName="nombre" class="grade-input"></h5>
                    <button type="button" (click)="removeGrado(i, j)" class="btn-remove">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                  <div *ngIf="grados(i).at(j).get('nombre')?.invalid && grados(i).at(j).get('nombre')?.touched" class="error-message">
                    El nombre del grado es requerido.
                  </div>
                  <div>Secciones:</div>
                  <ul class="info-list">
                    <li *ngFor="let seccion of grados(i).at(j).get('secciones')?.value">
                      <span>{{ seccion.nombre }} ({{ seccion.vacantes }} vac.)</span>
                    </li>
                  </ul>
                  <button class="btn-edit-grade" (click)="openSectionsModal(i, j)">EDITAR</button>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Botones de Edición -->
    <div class="edit-modal-footer">
      <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">Cancelar</button>
      <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    </div>
  </form>
</div>

<!-- Modal de Edición de Secciones -->
<div class="edit-modal-overlay" *ngIf="showSectionsModal">
  <div class="edit-modal-container">
    <button class="close-button" (click)="closeSectionsModal()"><i class="fas fa-times"></i></button>
    <form [formGroup]="sectionsForm" novalidate>
      <h2 class="edit-modal-title">Editar Secciones</h2>
      <div formArrayName="secciones">
        <div *ngFor="let seccionCtrl of sections().controls; let k=index" [formGroupName]="k" class="seccion-container">
          <div class="form-group">
            <label>Nombre Sección</label>
            <input type="text" formControlName="nombre" class="form-control">
            <div *ngIf="sections().at(k).get('nombre')?.invalid && sections().at(k).get('nombre')?.touched" class="error-message">
              El nombre de la sección es requerido.
            </div>
          </div>
          <div class="form-group">
            <label>N° Vacantes</label>
            <input type="number" formControlName="vacantes" class="form-control">
            <div *ngIf="sections().at(k).get('vacantes')?.invalid && sections().at(k).get('vacantes')?.touched" class="error-message">
              <span *ngIf="sections().at(k).get('vacantes')?.errors?.['required']">Las vacantes son requeridas.</span>
              <span *ngIf="sections().at(k).get('vacantes')?.errors?.['min']">Debe ser al menos 0.</span>
            </div>
          </div>
          <button type="button" (click)="removeSeccion(k)" class="btn-remove">
            <i class="fas fa-trash-alt"></i>
          </button>
        </div>
      </div>
      <div class="dynamic-section-header">
        <button type="button" (click)="addSeccion()" class="btn-add-small">
          <i class="fas fa-plus"></i> Añadir Sección
        </button>
      </div>
      <div class="edit-modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeSectionsModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="saveSections()">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>
