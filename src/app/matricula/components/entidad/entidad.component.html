<app-general-loading-spinner [visible]="cargando || guardando" [message]="mensajeSpinner"></app-general-loading-spinner>

<!-- Vista de Solo Lectura -->
<div class="main-container" *ngIf="!editando && entidad && !cargando">
  <div class="header center-aligned">
    <h2>{{ entidad.nombreColegio }}</h2>
    <div class="logo-container">
      <img [src]="entidad.logoColegio" alt="Logo del Colegio">
    </div>
  </div>

  <div class="form-columns">
    <!-- Columna 1: Datos de contacto y documentos -->
    <div class="column">
      <div class="form-group">
        <label>RUC del Colegio</label>
        <div class="input-with-icon">
          <i class="fas fa-id-card input-icon"></i>
          <input type="text" [value]="entidad.rucColegio" disabled>
        </div>
      </div>
      <div class="form-group">
        <label>Razón Social</label>
        <div class="input-with-icon">
          <i class="fas fa-signature input-icon"></i>
          <input type="text" [value]="entidad.razonSocial" disabled>
        </div>
      </div>
      <div class="info-section">
        <h3><i class="fas fa-file-alt"></i> Documentos Requeridos</h3>
        <div class="info-group" *ngIf="entidad.documentos?.necesarios">
          <h4>Necesarios</h4>
          <ul class="info-list">
            <li><span>{{ entidad.documentos?.necesarios?.documento1 }}</span></li>
            <li><span>{{ entidad.documentos?.necesarios?.documento2 }}</span></li>
          </ul>
        </div>
        <div class="info-group" *ngIf="entidad.documentos?.adicionales">
          <h4>Adicionales</h4>
          <ul class="info-list">
            <li *ngIf="entidad.documentos?.adicionales?.intercambio">
              <h5>Intercambio</h5>
              <ul class="info-list">
                <li><span>{{ entidad.documentos?.adicionales?.intercambio?.documento1 }}</span></li>
                <li><span>{{ entidad.documentos?.adicionales?.intercambio?.documento2 }}</span></li>
              </ul>
            </li>
            <li *ngIf="entidad.documentos?.adicionales?.discapacidad">
              <h5>Discapacidad</h5>
              <ul class="info-list">
                <li><span>{{ entidad.documentos?.adicionales?.discapacidad?.documento1 }}</span></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Columna 2: Dirección, Teléfono, Correo y Niveles -->
    <div class="column">
      <div class="form-group">
        <label>Dirección</label>
        <div class="input-with-icon">
          <i class="fas fa-map-marker-alt input-icon"></i>
          <input type="text" [value]="entidad.direccionColegio" disabled>
        </div>
      </div>
      <div class="form-group">
        <label>Teléfono</label>
        <div class="input-with-icon">
          <i class="fas fa-phone input-icon"></i>
          <input type="tel" [value]="entidad.telefonoColegio" disabled>
        </div>
      </div>
      <div class="form-group">
        <label>Correo Electrónico</label>
        <div class="input-with-icon">
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" [value]="entidad.correoColegio" disabled>
        </div>
      </div>
      <div class="info-section">
        <h3><i class="fas fa-clipboard-list"></i> Datos Niveles</h3>
        <div class="grade-grid-wrapper">
          <ng-container *ngFor="let nivel of entidad.datosngs?.niveles; let nivelIndex = index">
            <h4 class="level-name"><b>{{ nivel.nombre }}</b></h4>
            <div class="grade-carousel-container-normal">
              <button type="button" *ngIf="mostrarFlechaIzquierda(nivelIndex)" class="carousel-arrow left-arrow" (click)="moverIzquierda(nivelIndex)">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="carousel-viewport" #carouselViewport>
                <div class="grade-carousel" [ngStyle]="{'transform': 'translateX(' + getTranslateX(nivelIndex) + 'px)'}">
                  <div class="grade-card" *ngFor="let grado of nivel.grados; let gradoIndex = index">
                    <div class="grade-header">
                      <h5>Grado: {{ grado.nombre }}°</h5>
                      <app-tooltip [tooltipText]="'Editar'">
                        <button type="button" class="btn-edit-grade" (click)="abrirModalSecciones(nivelIndex, gradoIndex)"><i class="fas fa-pencil-alt"></i></button>
                      </app-tooltip>
                    </div>
                    <div>Secciones:</div>
                    <ul class="info-list">
                      <li *ngFor="let seccion of grado.secciones">
                        <span>{{ seccion.nombre }} ({{ seccion.vacantes }} vac.)</span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <button type="button" *ngIf="mostrarFlechaDerecha(nivelIndex)" class="carousel-arrow right-arrow" (click)="moverDerecha(nivelIndex)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
  <div class="button-container">
    <button type="button" class="btn btn-primary" (click)="iniciarEdicion()">EDITAR</button>
  </div>
</div>

<!-- Vista de Edición -->
<div class="main-container" *ngIf="editando && entidad && !cargando">
  <form [formGroup]="formularioEntidad" (ngSubmit)="guardarCambios()" novalidate>
    <div class="header left-aligned">
      <div class="form-group nombre-colegio-group">
        <label for="nombreColegio">Nombre del Colegio</label>
        <input id="nombreColegio" type="text" formControlName="nombreColegio" class="form-control">
        <div *ngIf="formularioEntidad.get('nombreColegio')?.invalid && formularioEntidad.get('nombreColegio')?.touched" class="error-message">
          El nombre es requerido.
        </div>
      </div>
      <div class="logo-section">
        <div class="logo-container">
          <img [src]="vistaPreviaLogo || 'assets/placeholder.png'" alt="Logo del Colegio">
          <div class="upload-overlay">
            <div class="upload-circle" (click)="activarInputArchivo()">SELECCIONAR IMAGEN</div>
          </div>
          <input type="file" #logoInput hidden (change)="alCambiarLogo($event)" accept="image/*">
          <div *ngIf="formularioEntidad.get('logoColegio')?.invalid && formularioEntidad.get('logoColegio')?.touched" class="error-message">
            <span *ngIf="formularioEntidad.get('logoColegio')?.errors?.['required']">El logo es requerido.</span>
            <span *ngIf="formularioEntidad.get('logoColegio')?.errors?.['invalidUrl']">Formato de logo inválido.</span>
          </div>
        </div>
        <div class="logo-info">
          Solo se permite formato PNG, JPG y JPEG y el archivo no debe pesar más de 2MB.
        </div>
      </div>
    </div>

    <div class="form-columns">
      <!-- Columna 1 -->
      <div class="column">
        <h4>Datos Generales</h4>
        <!-- RUC -->
        <div class="form-group">
          <label for="rucColegio">RUC</label>
          <input id="rucColegio" type="text" formControlName="rucColegio" class="form-control" maxlength="11">
          <div *ngIf="formularioEntidad.get('rucColegio')?.invalid && formularioEntidad.get('rucColegio')?.touched" class="error-message">
            <span *ngIf="formularioEntidad.get('rucColegio')?.errors?.['required']">RUC es requerido.</span>
            <span *ngIf="formularioEntidad.get('rucColegio')?.errors?.['pattern']">RUC debe tener 11 dígitos numéricos.</span>
          </div>
        </div>
        <!-- Razón Social -->
        <div class="form-group">
          <label for="razonSocial">Razón Social</label>
          <input id="razonSocial" type="text" formControlName="razonSocial" class="form-control">
          <div *ngIf="formularioEntidad.get('razonSocial')?.invalid && formularioEntidad.get('razonSocial')?.touched" class="error-message">
            La razón social es requerida.
          </div>
        </div>
      </div>
      <!-- Columna 2 -->
      <div class="column">
        <h4>Datos de Contacto</h4>
        <!-- Dirección -->
        <div class="form-group">
          <label for="direccionColegio">Dirección</label>
          <input id="direccionColegio" type="text" formControlName="direccionColegio" class="form-control">
          <div *ngIf="formularioEntidad.get('direccionColegio')?.invalid && formularioEntidad.get('direccionColegio')?.touched" class="error-message">
            La dirección es requerida.
          </div>
        </div>
        <!-- Teléfono -->
        <div class="form-group">
          <label for="telefonoColegio">Teléfono</label>
          <input id="telefonoColegio" type="tel" formControlName="telefonoColegio" class="form-control" maxlength="8">
          <div *ngIf="formularioEntidad.get('telefonoColegio')?.invalid && formularioEntidad.get('telefonoColegio')?.touched" class="error-message">
            <span *ngIf="formularioEntidad.get('telefonoColegio')?.errors?.['required']">El teléfono es requerido.</span>
            <span *ngIf="formularioEntidad.get('telefonoColegio')?.errors?.['pattern']">Debe tener 7 u 8 dígitos numéricos.</span>
          </div>
        </div>
        <!-- Correo -->
        <div class="form-group">
          <label for="correoColegio">Correo Electrónico</label>
          <input id="correoColegio" type="email" formControlName="correoColegio" class="form-control">
          <div *ngIf="formularioEntidad.get('correoColegio')?.invalid && formularioEntidad.get('correoColegio')?.touched" class="error-message">
            <span *ngIf="formularioEntidad.get('correoColegio')?.errors?.['required']">El correo es requerido.</span>
            <span *ngIf="formularioEntidad.get('correoColegio')?.errors?.['email']">Ingrese un correo válido.</span>
          </div>
        </div>
      </div>
    </div>

    <hr class="form-divider">

    <!-- Sección Documentos -->
    <div formGroupName="documentos">
      <h4>Documentos Requeridos</h4>
      <div class="form-columns">
        <div class="column" formGroupName="necesarios">
          <div class="dynamic-section-header">
            <h5>Necesarios</h5>
            <app-tooltip [tooltipText]="'Agregar'">
              <button type="button" (click)="agregarDocumentoNecesario()" class="btn-add-small"><i class="fas fa-plus"></i></button>
            </app-tooltip>
          </div>
          <div class="carousel-vertical-container">
            <button type="button" *ngIf="mostrarFlechaArribaNecesarios()" class="carousel-arrow-vertical top-arrow" (click)="moverArribaNecesarios()">
              <i class="fas fa-chevron-up"></i>
            </button>
            <div class="carousel-viewport-vertical" #necesariosViewport>
              <div class="carousel-vertical" #necesariosContent [ngStyle]="{'transform': 'translateY(' + getTranslateYNecesarios() + 'px)'}">
                <ng-container *ngFor="let key of keysNecesarios; let i = index">
                  <div class="seccion-container">
                    <div class="form-group">
                      <label>Documento {{i + 1}}</label>
                      <input type="text" [formControlName]="key" class="form-control">
                      <div *ngIf="formularioEntidad.get('documentos.necesarios.' + key)?.invalid && formularioEntidad.get('documentos.necesarios.' + key)?.touched" class="error-message">
                        Este documento es requerido.
                      </div>
                    </div>
                    <app-tooltip [tooltipText]="'Eliminar'">
                      <button type="button" (click)="eliminarDocumentoNecesario(i)" class="btn-remove"><i class="fas fa-trash-alt"></i></button>
                    </app-tooltip>
                  </div>
                </ng-container>
              </div>
            </div>
            <button type="button" *ngIf="mostrarFlechaAbajoNecesarios()" class="carousel-arrow-vertical bottom-arrow" (click)="moverAbajoNecesarios()">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
        </div>
        <div class="column" formGroupName="adicionales">
          <div class="dynamic-section-header">
            <h5>Adicionales</h5>
            <app-tooltip [tooltipText]="'Agregar Categoría'">
              <button type="button" (click)="agregarCategoriaAdicional()" class="btn-add-small"><i class="fas fa-plus"></i></button>
            </app-tooltip>
          </div>
          <div class="carousel-vertical-container">
            <button type="button" *ngIf="mostrarFlechaArribaAdicionales()" class="carousel-arrow-vertical top-arrow" (click)="moverArribaAdicionales()">
              <i class="fas fa-chevron-up"></i>
            </button>
            <div class="carousel-viewport-vertical" #adicionalesViewport>
              <div class="carousel-vertical" #adicionalesContent [ngStyle]="{'transform': 'translateY(' + getTranslateYAdicionales() + 'px)'}">
                <ng-container *ngFor="let catKey of keysAdicionales; let catIndex = index">
                  <div formGroupName="{{catKey}}">
                    <div class="dynamic-section-header">
                      <h6><input type="text" formControlName="nombre" class="form-control" placeholder="Nombre de Categoría"></h6>
                      <app-tooltip [tooltipText]="'Agregar Documento'">
                        <button type="button" (click)="agregarDocumentoAdicional(catKey)" class="btn-add-small"><i class="fas fa-plus"></i></button>
                      </app-tooltip>
                      <app-tooltip [tooltipText]="'Eliminar Categoría'">
                        <button type="button" (click)="eliminarCategoriaAdicional(catIndex)" class="btn-remove"><i class="fas fa-trash-alt"></i></button>
                      </app-tooltip>
                    </div>
                    <ng-container *ngFor="let docKey of keysDocumentosAdicionales(catKey); let docIndex = index">
                      <div class="seccion-container">
                        <div class="form-group">
                          <label>Documento {{docIndex + 1}}</label>
                          <input type="text" [formControlName]="docKey" class="form-control">
                        </div>
                        <app-tooltip [tooltipText]="'Eliminar'">
                          <button type="button" (click)="eliminarDocumentoAdicional(catKey, docIndex)" class="btn-remove"><i class="fas fa-trash-alt"></i></button>
                        </app-tooltip>
                      </div>
                    </ng-container>
                  </div>
                </ng-container>
              </div>
            </div>
            <button type="button" *ngIf="mostrarFlechaAbajoAdicionales()" class="carousel-arrow-vertical bottom-arrow" (click)="moverAbajoAdicionales()">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <hr class="form-divider">

    <!-- Datos Niveles -->
    <div formGroupName="datosngs">
      <div class="info-section">
        <div class="dynamic-section-header">
          <h3><i class="fas fa-clipboard-list"></i> Datos Niveles</h3>
          <app-tooltip [tooltipText]="'Agregar'">
            <button type="button" (click)="agregarNivel()" class="btn-add-small"><i class="fas fa-plus"></i></button>
          </app-tooltip>
        </div>
        <div *ngIf="niveles().invalid && niveles().touched" class="error-message">
          Debe haber al menos un nivel educativo.
        </div>
        <div class="grade-grid-wrapper" formArrayName="niveles">
          <ng-container *ngFor="let nivelCtrl of niveles().controls; let i=index" [formGroupName]="i">
            <div class="level-header">
              <h4 class="level-name">
                <b><input type="text" formControlName="nombre" class="level-input"></b>
              </h4>
              <app-tooltip [tooltipText]="'Eliminar'">
                <button type="button" (click)="eliminarNivel(i)" class="btn-remove"><i class="fas fa-trash-alt"></i></button>
              </app-tooltip>
              <app-tooltip [tooltipText]="'Agregar'">
                <button type="button" (click)="agregarGrado(i)" class="btn-add-small"><i class="fas fa-plus"></i></button>
              </app-tooltip>
            </div>
            <div *ngIf="niveles().at(i).get('nombre')?.invalid && niveles().at(i).get('nombre')?.touched" class="error-message">
              El nombre del nivel es requerido.
            </div>
            <div *ngIf="grados(i).invalid && grados(i).touched" class="error-message">
              Debe haber al menos un grado.
            </div>
            <div class="grade-carousel-container-edit" formArrayName="grados">
              <button type="button" *ngIf="mostrarFlechaIzquierda(i)" class="carousel-arrow left-arrow" (click)="moverIzquierda(i)">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div class="carousel-viewport" #carouselViewport>
                <div class="grade-carousel" [ngStyle]="{'transform': 'translateX(' + getTranslateX(i) + 'px)'}">
                  <ng-container *ngFor="let gradoCtrl of grados(i).controls; let j=index" [formGroupName]="j">
                    <div class="grade-card">
                      <div class="grade-header">
                        <h5>Grado: <input type="text" formControlName="nombre" class="grade-input"></h5>
                        <app-tooltip [tooltipText]="'Editar'">
                          <button type="button" class="btn-edit-grade" (click)="abrirModalSecciones(i, j)"><i class="fas fa-pencil-alt"></i></button>
                        </app-tooltip>
                        <app-tooltip [tooltipText]="'Eliminar'">
                          <button type="button" (click)="eliminarGrado(i, j)" class="btn-remove"><i class="fas fa-trash-alt"></i></button>
                        </app-tooltip>
                      </div>
                      <div *ngIf="grados(i).at(j).get('nombre')?.invalid && grados(i).at(j).get('nombre')?.touched" class="error-message">
                        El nombre del grado es requerido.
                      </div>
                      <div>Secciones:</div>
                      <ul class="info-list">
                        <li *ngFor="let seccion of grados(i).at(j).get('secciones')?.value">
                          <span>{{ seccion.nombre }} ({{ seccion.vacantes }} vac.)</span>
                        </li>
                      </ul>
                    </div>
                  </ng-container>
                </div>
              </div>
              <button type="button" *ngIf="mostrarFlechaDerecha(i)" class="carousel-arrow right-arrow" (click)="moverDerecha(i)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Botones de Edición -->
    <div class="button-container">
      <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">Cancelar</button>
      <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    </div>
  </form>
</div>

<!-- Modal de Edición de Secciones -->
<div class="edit-modal-overlay" *ngIf="mostrarModalSecciones">
  <div class="edit-modal-container">
    <button type="button" class="close-button" (click)="cerrarModalSecciones()"><i class="fas fa-times"></i></button>
    <form [formGroup]="formularioSecciones" novalidate>
      <div class="edit-modal-header">
        <h2 class="edit-modal-title">GRADO: {{ nombreGradoSeleccionado }}°</h2>
        <app-tooltip [tooltipText]="'Agregar'">
          <button type="button" (click)="agregarSeccion()" class="btn-add-small btn-add-spaced"><i class="fas fa-plus"></i></button>
        </app-tooltip>
      </div>
      <div formArrayName="secciones">
        <div *ngFor="let seccionCtrl of secciones().controls; let k=index" [formGroupName]="k" class="seccion-container">
          <div class="form-group">
            <label>Nombre Sección</label>
            <input type="text" formControlName="nombre" class="form-control">
            <div *ngIf="secciones().at(k).get('nombre')?.invalid && secciones().at(k).get('nombre')?.touched" class="error-message">
              El nombre de la sección es requerido.
            </div>
          </div>
          <div class="form-group">
            <label>N° Vacantes</label>
            <input type="number" formControlName="vacantes" class="form-control">
            <div *ngIf="secciones().at(k).get('vacantes')?.invalid && secciones().at(k).get('vacantes')?.touched" class="error-message">
              <span *ngIf="secciones().at(k).get('vacantes')?.errors?.['required']">Las vacantes son requeridas.</span>
              <span *ngIf="secciones().at(k).get('vacantes')?.errors?.['min']">Debe ser al menos 0.</span>
            </div>
          </div>
          <app-tooltip [tooltipText]="'Eliminar'">
            <button type="button" (click)="eliminarSeccion(k)" class="btn-remove"><i class="fas fa-trash-alt"></i></button>
          </app-tooltip>
        </div>
      </div>
      <div class="edit-modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalSecciones()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="guardarSecciones()">Guardar Cambios</button>
      </div>
    </form>
  </div>
</div>

<app-notification></app-notification>
